{% extends "base.html" %}

{% block title %}Junpei Wada's Blog{% endblock %}
{% block description %}技術、登山、旅行などについてのブログ{% endblock %}

{% block body_class %} class="index"{% endblock %}

{% block extra_head %}
<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

<!-- Lunr.js for search -->
<script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script>
{% endblock %}

{% block main_content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto text-center">
                <h1 class="hero-title">Junpei Wada's Blog</h1>
                <p class="hero-subtitle">技術・登山・旅行について書いています</p>
            </div>
        </div>
    </div>
</section>

<main class="container my-5">
    <!-- Global Search Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="search-container">
                <input type="text" id="globalSearch" class="form-control form-control-lg" 
                       placeholder="全記事から検索 (タイトル・本文・タグ)..." autocomplete="off">
                <div id="searchResults" class="search-results"></div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <div class="row">
            <div class="col-md-8">
                <h5 class="mb-3"><i class="bi bi-funnel"></i> フィルタ</h5>
                <div class="mb-3">
                    <button class="btn btn-outline-primary filter-btn" data-category="all" id="filterAll">
                        全て ({{ posts|length }})
                    </button>
                    <button class="btn btn-outline-success filter-btn" data-category="mountain-guide">
                        山岳ガイド
                    </button>
                    <button class="btn btn-outline-info filter-btn" data-category="sea">
                        海・釣り
                    </button>
                    <button class="btn btn-outline-warning filter-btn" data-category="gear">
                        ギア・道具
                    </button>
                    <button class="btn btn-outline-danger filter-btn" data-category="tech">
                        技術
                    </button>
                    <button class="btn btn-outline-secondary filter-btn" data-category="travel">
                        旅行
                    </button>
                </div>
            </div>
            <div class="col-md-4">
                <h5 class="mb-3"><i class="bi bi-search"></i> ローカル検索</h5>
                <input type="text" id="localSearch" class="form-control" placeholder="表示中の記事を検索...">
            </div>
        </div>
    </div>

    <!-- Posts Grid -->
    <div class="row" id="postsContainer">
        {% for post in posts %}
        <div class="col-lg-4 col-md-6 mb-4 post-card" data-category="{{ post.category }}" data-tags="{{ post.tags|join(' ')|lower }}" data-title="{{ post.title|lower }}" data-description="{{ post.description|lower }}">
            <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column">
                    <div class="mb-2">
                        <span class="badge bg-primary rounded-pill">{{ post.category }}</span>
                        <small class="text-muted float-end">{{ post.date }}</small>
                    </div>
                    
                    <h5 class="card-title">
                        <a href="posts/{{ post.filename }}" class="text-decoration-none">{{ post.title }}</a>
                    </h5>
                    
                    <p class="card-text">{{ post.description }}</p>
                    
                    {% if post.tags %}
                    <div class="mb-3 mt-auto">
                        {% for tag in post.tags %}
                        <span class="tag">{{ tag }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="mt-auto">
                        <a href="posts/{{ post.filename }}" class="btn btn-outline-primary btn-sm">続きを読む</a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- No Results Message -->
    <div id="noResults" class="text-center py-5" style="display: none;">
        <i class="bi bi-search display-1 text-muted"></i>
        <h3 class="text-muted mt-3">該当する記事が見つかりません</h3>
        <p class="text-muted">検索条件を変更してお試しください</p>
    </div>
</main>
{% endblock %}

{% block extra_scripts %}
<script>
// Global Search Implementation
let searchIndex;
let searchDocuments = [];

// Load search index
fetch('search-index.json')
    .then(response => response.json())
    .then(data => {
        searchDocuments = data;
        searchIndex = lunr(function () {
            this.field('title', { boost: 10 });
            this.field('description', { boost: 5 });
            this.field('tags', { boost: 3 });
            this.field('category', { boost: 2 });
            this.field('content');
            this.ref('id');

            data.forEach(doc => this.add(doc));
        });
    })
    .catch(err => console.error('Failed to load search index:', err));

// Global search functionality
const globalSearch = document.getElementById('globalSearch');
const searchResults = document.getElementById('searchResults');

globalSearch.addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    if (query.length < 2) {
        searchResults.style.display = 'none';
        return;
    }
    
    if (!searchIndex) {
        searchResults.innerHTML = '<div class="search-result-item">検索インデックスを読み込み中...</div>';
        searchResults.style.display = 'block';
        return;
    }
    
    try {
        const results = searchIndex.search(query + '*').slice(0, 10);
        
        if (results.length === 0) {
            searchResults.innerHTML = '<div class="search-result-item">該当する記事が見つかりません</div>';
        } else {
            searchResults.innerHTML = results.map(result => {
                const doc = searchDocuments.find(d => d.id === result.ref);
                if (!doc) return '';
                
                return `
                    <a href="posts/${doc.id}.html" class="search-result-item">
                        <div class="search-result-title">${highlightText(doc.title, query)}</div>
                        <div class="search-result-meta">
                            <span class="badge bg-secondary">${doc.category}</span>
                            <span class="ms-2">${doc.date}</span>
                        </div>
                        <div class="search-result-excerpt">${highlightText(doc.description.substring(0, 150), query)}...</div>
                    </a>
                `;
            }).join('');
        }
        
        searchResults.style.display = 'block';
    } catch (error) {
        console.error('Search error:', error);
        searchResults.innerHTML = '<div class="search-result-item">検索エラーが発生しました</div>';
        searchResults.style.display = 'block';
    }
});

// Hide search results when clicking outside
document.addEventListener('click', function(e) {
    if (!globalSearch.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.style.display = 'none';
    }
});

// Highlight search terms
function highlightText(text, query) {
    if (!query) return text;
    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<span class="search-highlight">$1</span>');
}

// Local search and filtering
const localSearch = document.getElementById('localSearch');
const filterButtons = document.querySelectorAll('.filter-btn');
const postCards = document.querySelectorAll('.post-card');
const noResults = document.getElementById('noResults');
const postsContainer = document.getElementById('postsContainer');

let currentCategory = 'all';

// Filter functionality
filterButtons.forEach(button => {
    button.addEventListener('click', function() {
        filterButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        currentCategory = this.dataset.category;
        applyFilters();
    });
});

// Set initial active filter
document.getElementById('filterAll').classList.add('active');

// Local search functionality
localSearch.addEventListener('input', applyFilters);

function applyFilters() {
    const searchTerm = localSearch.value.toLowerCase();
    let visibleCount = 0;
    
    postCards.forEach(card => {
        const category = card.dataset.category;
        const title = card.dataset.title;
        const description = card.dataset.description;
        const tags = card.dataset.tags;
        
        const categoryMatch = currentCategory === 'all' || category === currentCategory;
        const searchMatch = searchTerm === '' || 
            title.includes(searchTerm) || 
            description.includes(searchTerm) || 
            tags.includes(searchTerm);
        
        if (categoryMatch && searchMatch) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Show/hide no results message
    if (visibleCount === 0) {
        postsContainer.style.display = 'none';
        noResults.style.display = 'block';
    } else {
        postsContainer.style.display = 'flex';
        noResults.style.display = 'none';
    }
}
</script>
{% endblock %}