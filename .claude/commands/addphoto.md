# /addphoto コマンド

既存の記事に新しい写真URLを追加します。写真のダウンロード・分析・最適化URLの生成を行い、記事に適切な形式で挿入します。

## 使用方法

```
/addphoto 新しい写真URL（Google Photos共有URLやその他の写真URL）
```

## 実行内容

このコマンドは既存記事への写真追加を支援します：

1. **既存記事の特定**
   - 現在開いているファイルまたは最新の記事を対象
   - 記事のカテゴリと内容を確認

2. **写真の処理・分析**
   - Google Photos URLから画像を抽出・ダウンロード  
   - EXIF情報から撮影日時を抽出
   - `s800-no-gm`形式の最適化URLを生成

3. **記事への統合**
   - 撮影日時に基づいて適切な挿入位置を決定
   - 既存の写真との時系列を考慮
   - 最適化URLで記事に追加

---

新しい写真を既存記事に追加します。

**提供された写真情報**: $ARGUMENTS

## Step 1: 写真の処理

### Google Photos URLの場合
提供されたURLがGoogle Photosの共有URLの場合：

```bash
# 1. URL抽出
google_photos_extractor.pyは写真の枚数によって非常に時間がかかるのでタイムアウトを15分程度に設定して実行を待つ必要があります。

python scripts/google_photos_extractor.py "$ARGUMENTS" --headless

# 2. 画像ダウンロード・分析（一時的に追加写真として）
python scripts/download_images_for_review.py --clean [抽出されたURL] --article-title "追加写真"
```

### 直接画像URLの場合
```bash
# 直接ダウンロード・分析
python scripts/download_images_for_review.py --clean "$ARGUMENTS" --article-title "追加写真"
```

## Step 2: 記事への統合

### 現在開いている記事を確認
既存記事の構造と内容を分析：

1. **記事の日付と時系列を確認**
2. **既存写真の撮影時刻を確認**
3. **新しい写真の撮影時刻を確認**
4. **適切な挿入位置を決定**

### 写真の追加形式
```markdown
![写真の説明](s800-no-gm最適化URL)
```

## Step 3: 品質チェック

### 追加写真のチェックポイント
- ✅ **最適化URL使用**: `s800-no-gm`形式のURLを使用
- ✅ **時系列の整合性**: 撮影時刻に基づく適切な配置
- ✅ **説明文**: 写真内容に合った適切な説明文
- ✅ **記事の流れ**: 既存内容との自然な統合

### 記事更新後の確認
```bash
# ローカルでプレビュー確認
npm run serve

# 問題なければビルド・公開
npm run ビルドして公開
```

## 注意事項

### 写真の時系列について
- 新しい写真の撮影時刻が既存記事の日付範囲外の場合は警告
- 時系列が前後する場合は適切な位置への挿入を提案
- 撮影日時が大きく異なる場合は別記事作成を推奨

### 記事の一貫性
- 追加写真が記事のテーマ・内容と整合しているかを確認
- カテゴリやタグの更新が必要かを検討
- featured_imageの変更が適切かを判断

## Step 4: 実行手順詳細

### 1. 現在開いている記事の分析
```
1. 記事タイトルと日付を確認
2. 既存写真のEXIF情報と配置を確認  
3. 記事の時系列構造を把握
```

### 2. 新写真の分析結果確認
```bash
# scripts/tmp/image_analysis_*.md を確認
# - 撮影日時
# - 最適化URL（s800-no-gm）
# - 写真内容
```

### 3. 挿入位置の決定
**時系列ベース挿入ルール:**
- 撮影時刻が早い → 記事の前の方に挿入
- 撮影時刻が遅い → 記事の後の方に挿入
- 時系列が前後 → 適切なセクションに挿入し説明を追加

### 4. 記事の更新
```markdown
<!-- 時系列に応じた適切な位置に挿入 -->
![新しい写真の説明](s800-no-gm-最適化URL)

追加の説明文もあわせて記載...
```

### 5. 最終チェックと公開
```bash
# プレビューで確認
npm run serve

# 問題なければ公開
npm run ビルドして公開
```

## エラーハンドリング

### よくある問題と対処法

**❌ 撮影日時が記事日付と大きく乖離**
```
対処: 別記事への分離を提案、または説明追加
```

**❌ Google Photos URLの抽出失敗**
```
対処: 手動URL提供をリクエスト、または別の方法を提案
```

**❌ 画像の内容が記事テーマと不整合**
```
対処: 写真の適切性を確認、別記事作成を提案
```

記事への写真追加が完了したら、内容の整合性と品質を確認してください。